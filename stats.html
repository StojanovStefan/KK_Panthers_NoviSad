<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Player Stats</title>
    <style>
      body {
        background: #e5e7eb;
        color: black;
        font-family: Arial;
        padding: 20px;
      }
      h1 {
        margin-top: 0;
      }
      .teamStats {
        margin-bottom: 40px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th {
        color: white;
      }
      th,
      td {
        padding: 6px;
        border: 1px solid #d1d5db;
        text-align: center;
      }
      th {
        background: #6b7280;
      }
      td {
        background: white;
      }
      .player-name {
        text-align: left;
      }
      .team-header {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .team-header img {
        height: 50px;
        width: 50px;
        object-fit: cover;
        border-radius: 50%;
      }

      .game-header {
        background: #d1d5db;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 30px;
      }

      .game-header .teams {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .big-logo {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        object-fit: cover;
        border: 6px solid white;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      }

      .team-block {
        text-align: center;
        width: 45%;
      }

      .team-name-large {
        margin-top: 10px;
        font-size: 22px;
        font-weight: bold;
      }

      .score-big {
        font-size: 48px;
        white-space: nowrap;
        min-width: 60px;
        text-align: center;
      }

      @media (max-width: 1024px) {
        .score-big {
          font-size: 36px;
        }
      }

      @media (max-width: 768px) {
        .score-big {
          font-size: 28px;
        }
      }

      .game-info {
        margin-bottom: 15px;
        font-size: 16px;
        color: #444;
      }

      .top-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        width: 100%;
      }

      .switch-btn {
        padding: 10px 18px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        background: #d1d5db;
        font-weight: normal;
      }

      .switch-btn.active {
        background: #fbbf24;
      }

      #teamTotals {
        display: none;
        background-color: white;
        border-radius: 20px;
        margin-top: 20px;
      }

      #teamTotals strong {
        color: #f37e12;
      }
      .stat-row {
        display: flex;
        font-size: larger;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
      }
      .stat-row div:first-child {
        padding-left: 20px;
        font-weight: bold;
      }

      .stat-row div:last-child {
        padding-right: 20px;
        font-weight: bold;
      }
      .bar-container {
        flex: 1;
        height: 8px;
        background: #eef2f6;
        border-radius: 5px;
        margin: 0 12px;
        overflow: hidden;
      }
      .bar-primary {
        height: 100%;
        background: #fbbf24;
      }

      .bar-secondary {
        height: 100%;
        background: #9ca3af;
      }

      #timelineContainer {
        position: relative;
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #timelineContainer::before {
        content: "";
        position: absolute;
        left: 50%;
        width: 2px;
        height: 100%;
        background: #d1d5db;
        transform: translateX(-50%);
        z-index: 0;
      }

      .event-card {
        display: flex;
        position: relative;
        width: 45%;
        margin: 10px 0;
        padding: 10px 15px;
        border-radius: 12px;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 1;
      }

      .event-left {
        margin-right: auto;
        border-left: 4px solid #6a0dad;
        flex-direction: row;
      }

      .event-right {
        margin-left: auto;
        border-right: 4px solid #0a1d4d;
        flex-direction: row-reverse;
      }

      .event-logo {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 10px;
      }

      .event-right .event-logo {
        margin-left: 10px;
        margin-right: 0;
      }

      .event-text {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 5px;
      }

      .event-player {
        font-weight: bold;
        margin: 0;
      }

      .event-type {
        font-size: 14px;
        color: #333;
        margin: 0;
      }

      .timeline-score {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        background: #fbbf24;
        color: black;
        font-weight: bold;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        margin-top: 5px;
        z-index: 5;
      }
    </style>
  </head>
  <body>
    <div id="gameHeader"></div>

    <div class="top-buttons">
      <button id="btnTotals" class="switch-btn">STATISTIKA</button>
      <button id="btnPlayers" class="switch-btn active">
        STATISTIKA IGRAƒåA
      </button>
      <button id="btnTimeline" class="switch-btn">TOK UTAKMICE</button>
    </div>

    <div id="timelineContainer" style="display: none"></div>

    <div id="teamTotals"></div>
    <div id="statsContainer"></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBrMu0mjZw1SIh-0KgEVaKoPURdN1PhC0w",
        authDomain: "kk-panthers-39d91.firebaseapp.com",
        databaseURL:
          "https://kk-panthers-39d91-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "kk-panthers-39d91",
        storageBucket: "kk-panthers-39d91.appspot.com",
        messagingSenderId: "605710897252",
        appId: "1:605710897252:web:9469a8022065af45748f71",
        measurementId: "G-KL6BJPX04S",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let orderedTeams = [];
      let globalTeams = {};

      onValue(ref(db, "gameData/gameInfo"), (snap) => {
        const info = snap.val() || {};
        orderedTeams = [info.teamA, info.teamB];
        renderGameHeader(info);
      });

      function renderGameHeader(info) {
        const container = document.getElementById("gameHeader");
        container.innerHTML = `
          <div class="game-header">
            <div class="game-info">
              <span>üìç ${info.location || "Nepoznato"}</span> ‚Ä¢
              <span>üìÖ ${info.date || ""}</span> ‚Ä¢
              <span>üïí ${info.startTime || ""}</span>
            </div>

            <div class="teams">
              <div class="team-block">
                <img src="team_logo/${info.teamA_logo}" class="big-logo">
                <div class="team-name-large">${info.teamA}</div>
              </div>

              <div class="score-big">${info.scoreA ?? "-"} : ${
          info.scoreB ?? "-"
        }</div>

              <div class="team-block">
                <img src="team_logo/${info.teamB_logo}" class="big-logo">
                <div class="team-name-large">${info.teamB}</div>
              </div>
            </div>
          </div>`;
      }

      onValue(ref(db, "gameData/teams"), (snap) => {
        globalTeams = snap.val() || {};
        renderStats(globalTeams);
        renderTotals(globalTeams);
      });

      function renderStats(teams) {
        const container = document.getElementById("statsContainer");
        container.innerHTML = "";

        const sortedTeamNames = orderedTeams.filter((t) => teams[t]);

        for (const teamName of sortedTeamNames) {
          const team = teams[teamName];
          const players = team.players || {};

          const div = document.createElement("div");
          div.className = "teamStats";

          const h2 = document.createElement("h2");
          const headerDiv = document.createElement("div");
          headerDiv.className = "team-header";

          const logo = document.createElement("img");
          logo.src = "team_logo/" + (team.logo || "default.png");

          headerDiv.appendChild(logo);
          headerDiv.appendChild(document.createTextNode(teamName));
          h2.appendChild(headerDiv);
          div.appendChild(h2);

          const table = document.createElement("table");
          const thead = document.createElement("thead");
          const headerRow = document.createElement("tr");

          const headers = [
            "#",
            "Igraƒç",
            "EFF",
            "FG",
            "2P",
            "3P",
            "FT",
            "REB O/D",
            "AST",
            "TO",
            "STL",
            "BLK",
            "PTS",
          ];

          headers.forEach((h) => {
            const th = document.createElement("th");
            th.textContent = h;
            headerRow.appendChild(th);
          });

          thead.appendChild(headerRow);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");

          for (const number in players) {
            const p = players[number];
            const s = p.stats || {};

            const eff =
              (s.points || 0) +
              (s.rebounds_off || 0) +
              (s.rebounds_def || 0) +
              (s.assists || 0) +
              (s.steals || 0) +
              (s.blocks || 0) -
              (s.turnovers || 0) -
              ((s.fg_attempts || 0) -
                (s.fg_made || 0) +
                (s.ft_attempts || 0) -
                (s.ft_made || 0));

            const fgPct = s.fg_attempts
              ? Math.round((s.fg_made / s.fg_attempts) * 100) + "%"
              : "0%";
            const twoPct = s.two_attempts
              ? Math.round((s.two_made / s.two_attempts) * 100) + "%"
              : "0%";
            const threePct = s.three_attempts
              ? Math.round((s.three_made / s.three_attempts) * 100) + "%"
              : "0%";
            const ftPct = s.ft_attempts
              ? Math.round((s.ft_made / s.ft_attempts) * 100) + "%"
              : "0%";

            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${p.number}</td>
              <td class="player-name">${p.name}</td>
              <td>${eff}</td>
              <td>${s.fg_made}/${s.fg_attempts} ${fgPct}</td>
              <td>${s.two_made}/${s.two_attempts} ${twoPct}</td>
              <td>${s.three_made}/${s.three_attempts} ${threePct}</td>
              <td>${s.ft_made}/${s.ft_attempts} ${ftPct}</td>
              <td>${s.rebounds_off + s.rebounds_def}<br>${s.rebounds_off} / ${
              s.rebounds_def
            }</td>
              <td>${s.assists}</td>
              <td>${s.turnovers}</td>
              <td>${s.steals}</td>
              <td>${s.blocks}</td>
              <td>${s.points}</td>
            `;
            tbody.appendChild(row);
          }

          table.appendChild(tbody);
          div.appendChild(table);
          container.appendChild(div);
        }
      }

      /* ------------------ Game TimeLine ------------------ */

      onValue(ref(db, "gameData/events"), (snap) => {
        const events = snap.val() || {};
        renderTimeline(events);
      });

      function renderTimeline(events) {
        const container = document.getElementById("timelineContainer");
        container.innerHTML = "";

        const sortedEvents = Object.values(events).sort(
          (a, b) => a.timestamp - b.timestamp
        );

        function getTeamByPlayer(playerName) {
          for (const teamName in globalTeams) {
            const players = globalTeams[teamName].players || {};
            for (const num in players) {
              if (players[num].name === playerName) {
                return teamName;
              }
            }
          }
          return null;
        }

        let scoreA = 0;
        let scoreB = 0;

        sortedEvents.forEach((ev) => {
          const date = new Date(ev.timestamp);
          const minutes = String(date.getMinutes()).padStart(2, "0");
          const seconds = String(date.getSeconds()).padStart(2, "0");
          const time = `${minutes}:${seconds}`;

          let text = "";
          let points = 0;

          switch (ev.type) {
            case "points_2":
              text = "pogaƒëa ≈°ut za dva poena";
              points = 2;
              break;
            case "miss_2":
              text = "proma≈°uje ≈°ut za dva poena";
              break;
            case "points_3":
              text = "pogaƒëa ≈°ut za tri poena";
              points = 3;
              break;
            case "miss_3":
              text = "proma≈°uje ≈°ut za tri poena";
              break;
            case "points_1":
              points = 1;
              text = "pogaƒëa ≈°ut za jedan poen";
              break;
            case "miss_1":
              text = "proma≈°uje ≈°ut za jedan poen";
              break;
            case "assists":
              text = "Asistira";
              break;
            case "rebounds_def":
              text = "Skok u odbrani";
              break;
            case "rebounds_off":
              text = "Skok u napadu";
              break;
            case "steals":
              text = "osvaja loptu";
              break;
            case "turnovers":
              text = "gubi loptu";
              break;
            case "blocks":
              text = "Blokada";
              break;
            default:
              text = ev.type;
          }
          const teamName = ev.teamName || getTeamByPlayer(ev.playerName);
          const alignmentClass =
            teamName === orderedTeams[1] ? "event-right" : "event-left";
          const logo = globalTeams[teamName]?.logo || "default.png";

          let bubbleScore = null;

          if (points > 0) {
            if (teamName === orderedTeams[0]) scoreA += points;
            else scoreB += points;

            bubbleScore = `${scoreA} - ${scoreB}`;
          }

          if (bubbleScore) {
            const scoreBubble = document.createElement("div");
            scoreBubble.className = "timeline-score";
            scoreBubble.textContent = bubbleScore;
            container.appendChild(scoreBubble);
          }

          const div = document.createElement("div");
          div.className = `event-card ${alignmentClass}`;
          div.innerHTML = `
      <img src="team_logo/${logo}" class="event-logo">
      <div class="event-text">
        <div class="event-player">${ev.playerName} ${""}</div>
        <div class="event-type">${text} (${time})</div>
      </div>
    `;

          container.appendChild(div);
        });
      }

      /* ------------------ NEW FULL TOTALS ------------------ */

      function renderTotals(teams) {
        const container = document.getElementById("teamTotals");
        container.innerHTML = "";

        if (!orderedTeams.length) return;

        const [A, B] = orderedTeams;
        const tA = teams[A].team_stats || {};
        const tB = teams[B].team_stats || {};

        function pct(made, att) {
          if (!att || att === 0) return 0;
          return ((made / att) * 100).toFixed(1);
        }

        function row(label, a, b, max) {
          const showPercent = label.includes("%");

          const valA = Number(a ?? 0);
          const valB = Number(b ?? 0);

          const MAX_BAR_WIDTH = 30;

          const maxVal = Math.max(valA, valB, 1);

          const widthA = (valA / maxVal) * MAX_BAR_WIDTH;
          const widthB = (valB / maxVal) * MAX_BAR_WIDTH;

          const classA = valA >= valB ? "bar-primary" : "bar-secondary";
          const classB = valB > valA ? "bar-primary" : "bar-secondary";

          return `
    <div class="stat-row">

      <div style="width:60px">
        ${valA}${showPercent ? "%" : ""}
      </div>

      <div class="bar-container">
        <div class="${classA}" style="width:${widthA}%"></div>
      </div>

      <strong>${label}</strong>

      <div class="bar-container">
        <div class="${classB}" style="width:${widthB}%"></div>
      </div>

      <div style="width:60px;text-align:right">
        ${valB}${showPercent ? "%" : ""}
      </div>

    </div>
  `;
        }

        container.innerHTML = `
     ${row("Poeni", tA.points, tB.points, 150)}

     ${row("≈†ut iz igre poku≈°aj", tA.fg_attempts, tB.fg_attempts, 120)}
     ${row("≈†ut iz igre pogodak", tA.fg_made, tB.fg_made, 80)}
     ${row(
       "≈†ut iz igre %",
       pct(tA.fg_made, tA.fg_attempts),
       pct(tB.fg_made, tB.fg_attempts),
       100
     )}

     ${row("2 poena ≈°ut", tA.two_attempts, tB.two_attempts, 80)}
     ${row("2 poena pogodak", tA.two_made, tB.two_made, 50)}
     ${row(
       "2 poena %",
       pct(tA.two_made, tA.two_attempts),
       pct(tB.two_made, tB.two_attempts),
       100
     )}

     ${row("3 poena ≈°ut", tA.three_attempts, tB.three_attempts, 60)}
     ${row("3 poena pogodak", tA.three_made, tB.three_made, 30)}
     ${row(
       "3 poena %",
       pct(tA.three_made, tA.three_attempts),
       pct(tB.three_made, tB.three_attempts),
       100
     )}

     ${row("Slobodna bacanja poku≈°aj", tA.ft_attempts, tB.ft_attempts, 50)}
     ${row("Slobodna bacanja pogodak", tA.ft_made, tB.ft_made, 40)}
     ${row(
       "Slobodna bacanja %",
       pct(tA.ft_made, tA.ft_attempts),
       pct(tB.ft_made, tB.ft_attempts),
       100
     )}

     ${row("Ofanzivni skok", tA.rebounds_off, tB.rebounds_off, 30)}
     ${row("Defanzivni skok", tA.rebounds_def, tB.rebounds_def, 40)}
   ${row(
     "Skok",
     tA.rebounds_off + tA.rebounds_def,
     tB.rebounds_off + tB.rebounds_def,
     70
   )}

     ${row("Asistencije", tA.assists, tB.assists, 40)}
     ${row("Izgubljene lopte", tA.turnovers, tB.turnovers, 30)}
     ${row("Ukradene lopte", tA.steals, tB.steals, 25)}
     ${row("Blokade", tA.blocks, tB.blocks, 20)}
  `;
      }

      const btnT = document.getElementById("btnTotals");
      const btnP = document.getElementById("btnPlayers");
      const btnTimeline = document.getElementById("btnTimeline");

      btnT.onclick = () => {
        btnT.classList.add("active");
        btnP.classList.remove("active");
        btnTimeline.classList.remove("active");

        document.getElementById("teamTotals").style.display = "block";
        document.getElementById("statsContainer").style.display = "none";
        document.getElementById("timelineContainer").style.display = "none";
      };

      btnP.onclick = () => {
        btnP.classList.add("active");
        btnT.classList.remove("active");
        btnTimeline.classList.remove("active");

        document.getElementById("teamTotals").style.display = "none";
        document.getElementById("statsContainer").style.display = "block";
        document.getElementById("timelineContainer").style.display = "none";
      };

      btnTimeline.onclick = () => {
        btnTimeline.classList.add("active");
        btnP.classList.remove("active");
        btnT.classList.remove("active");

        document.getElementById("teamTotals").style.display = "none";
        document.getElementById("statsContainer").style.display = "none";
        document.getElementById("timelineContainer").style.display = "block";
      };
    </script>
  </body>
</html>
